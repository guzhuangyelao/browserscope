{% extends "base.html" %}

{% block head %}
<script src="/static/util.js"></script>
<script src="/static/xhrio.js"></script>
<script>
  var browserscope = {};
  browserscope.testCategories = [];
  {% for app_category in  app_categories %}
  browserscope.testCategories.push('{{ app_category.0 }}');
  {% endfor %}

  /**
   * This is the function that all test pages will call to beacon.
   * @param {Array} testResults test1=result,test2=result, etc..
   */
  browserscope.sendScore = function(testResults) {
    var uriParams = "category={{ app_category }}&results=" +
        testResults.join(',') + "&csrf_token={{ csrf_token }}";

    var results = '{{ app_category }}_results=' + testResults.join(',');
    {% if autorun %}
      var onComplete = function() {
        var continueUrl = unescape(Util.getParam('continue'));
        var nextUrl;
        if (continueUrl != '') {
          nextUrl = continueUrl + '&' + results;
        }

        for (var i = 0, n = browserscope.testCategories.legnth; i < n; i++) {
          var category = browserscope.testCategories[i];
          var results = Util.getParam(category + '_results');
          if (results) {
            nextUrl = nextUrl + '&' + category + '_results=' + results;
          }
        }
        window.location.href = nextUrl;
      };
      goog.net.XhrIo.send('/beacon', onComplete, 'post', uriParams);
    {% else %}
      var sendBeacon = document.getElementById('bs-send-beacon');
      if (sendBeacon.checked) {
        goog.net.XhrIo.send('/beacon', null, 'post', uriParams);
      }
      var seeMyResultsLink = document.getElementById('bs-see-my-results');
      if (!seeMyResultsLink) {
        seeMyResultsLink = document.createElement('a');
        seeMyResultsLink.id = 'bs-see-my-results';
        seeMyResultsLink.style.marginLeft = '.5em';
        seeMyResultsLink.appendChild(document.createTextNode(
            'See & compare my results'));
        document.getElementById('bs-runtest-c').appendChild(seeMyResultsLink);
      }
      seeMyResultsLink.href = '/?' + results;
    {% endif %}

    // Update the iframe size if there's one
    var doc = Util.getIframeDocument('bs-test-iframe');
    if (doc) {
      var height = Util.getDocumentHeight(doc);
      document.getElementById('bs-test-iframe').style.height = height + 10 + 'px';
    }
  };

  browserscope.runTest = function() {
    document.getElementById('bs-runtest').disabled = true;
    document.getElementById('bs-test-iframe').src = '{{ test_page }}';
  };
</script>
{% endblock %}

{% block body %}
  {% if autorun %}{% else %}
    <p id="bs-runtest-c">
      <button
        id="bs-runtest"
        class="bs-runtest"
        onclick="browserscope.runTest();"
        >Run {{ app_category_name }} Test</button>
      <label for="bs-send-beacon">
        <input id="bs-send-beacon" type="checkbox" checked="checked">
        Share my test results
      </label>
      <script>
        document.getElementById('bs-runtest').disabled = false;
      </script>
    </p>
  {% endif %}

  <iframe
    id="bs-test-iframe"
    name="{{ app_category }}"
    height="700px"
    width="100%"
    frameborder="0"
    src="/static/clicktorun.html"></iframe>
{% endblock %}

{% extends "base.html" %}

{% block head %}
<script src="/static/util.js"></script>
<script src="/static/xhrio.js"></script>
<script>
  var browserscope = {};
  browserscope.testCategories = [];
  {% for app_category in  app_categories %}
  browserscope.testCategories.push('{{ app_category.0 }}');
  {% endfor %}

  /**
   * This is the function that all test pages will call to beacon.
   * @param {Array} testResults test1=result,test2=result, etc..
   * @param {Array} opt_urlParams Possibly a subset of testResults for sending to the results page.
   */
  browserscope.sendScore = function(testResults, opt_continueParams) {
    var continueParams = opt_continueParams || null;
    browserscope.testResults = testResults;
    browserscope.uriResults = '{{ app_category }}_results=' +
        (continueParams ?
            escape(continueParams.join(',')) :
            escape(testResults.join(',')));

    var data = "category={{ app_category }}&results=" +
        testResults.join(',') + "&csrf_token={{ csrf_token }}";

    var sendBeacon = document.getElementById('bs-send-beacon');

    {% if autorun %}
      goog.net.XhrIo.send('/beacon', browserscope.onBeaconCompleteAutorun,
          'post', data);
    {% else %}
      if (sendBeacon.checked) {
        goog.net.XhrIo.send('/beacon', null, 'post', data);
      }
      browserscope.runTestButton.className = 'bs-btn';
      browserscope.runTestButton.innerHTML = 'Compare my results Â»';
      browserscope.runTestButton.href = '/?' + browserscope.uriResults;
    {% endif %}

    // Update the iframe size if there's one
    var doc = Util.getIframeDocument('bs-test-iframe');
    if (doc) {
      var height = Util.getDocumentHeight(doc);
      document.getElementById('bs-test-iframe').style.height = height + 10 + 'px';
    }
  };

  browserscope.onBeaconCompleteAutorun = function(e) {
    var continueToNextTest = '{{ continue }}';
    var len = browserscope.testCategories.length;
    var nextUrl;
    if (continueToNextTest != '' &&
        continueToNextTest != 'None') {
      var nextTest;
      for (var i = 0, n = len; i < n; i++) {
        if (browserscope.testCategories[i] == '{{ app_category }}') {
          // last test?
          if (i == len - 1) {
            nextTest = '/?';
          } else {
            nextTest = '/' + browserscope.testCategories[i + 1] +
                '/test?autorun=1&continue=1';
          }
        }
      }
      nextUrl = nextTest + '&' + browserscope.uriResults;

      // now add on previous test scores
      for (var i = 0, n = len; i < n; i++) {
        var category = browserscope.testCategories[i];
        var results = Util.getParam(category + '_results');
        if (results) {
          nextUrl += '&' + category + '_results=' + results;
        }
      }
      window.top.location.href = nextUrl;
    } else {
      //console.log('autorun but no continue');
    }
  };

  browserscope.runTest = function() {
    browserscope.runTestButton = document.getElementById('bs-runtest');
    browserscope.runTestButton.className = 'bs-btn-disabled';
    browserscope.runTestButton.onclick = '';
    browserscope.runTestButton.innerHTML = '{{ app_category_name }} Tests Running...';
    document.getElementById('bs-send-beacon-label').style.display = 'none';
    document.getElementById('bs-test-iframe').src = '{{ test_page }}';
    return false;
  };
</script>
{% endblock %}

{% block body %}
  {% if autorun %}{% else %}
    <p id="bs-runtest-c">
      <a
        id="bs-runtest"
        href=""
        class="bs-btn"
        onclick="return browserscope.runTest();"
        >Run the {{ app_category_name }} Tests</a>
      <label id="bs-send-beacon-label" for="bs-send-beacon">
        <input id="bs-send-beacon" type="checkbox" checked="checked">
        Share my test results
      </label>
    </p>
  {% endif %}

  <iframe
    id="bs-test-iframe"
    name="{{ app_category }}"
    height="700px"
    width="100%"
    frameborder="0"
    src="{% if autorun %}{{ test_page }}{% else %}/static/clicktorun.html{% endif %}"></iframe>
{% endblock %}

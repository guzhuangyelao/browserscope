{% extends "base.html" %}

{% block body %}

<div id="bs-home-intro-c" class="g-section">
  <div id="bs-home-recent-c">
    <div id="bs-home-recent">
      <h3>
        Recent tests
        {% if is_admin %}
          <a href="/clear_memcache?recent=1&continue=/" class="bs-admin">clear</a>
        {% endif %}
      </h3>
      <table id="bs-home-recent-tests" cellpadding="0" cellspacing="0">
        {% for test in recent_tests %}
          <tr>
            <td>{{ test.created|utc_to_pst|date:"P" }}</td>
            <td>{{ test.user_agent_pretty }}</td>
            <td>{{ test.category }}</td>
            <td>
              {% if test.display %}
                {{ test.display }}
              {% else %}
                {{ test.score }}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>
  </div>

  <p id="bs-home-intro">
    {{ app_title }} is a community-driven project for profiling web browsers.
    The goals are to foster innovation by tracking browser functionality and to be a resource for web developers.
  </p>
  <p id="bs-home-intro-sub">
    Gathering test results from users "in the wild" is the most important and useful feature of {{ app_title }} - and you can participate!
  </p>
  <p>
    <a href="/alltests" class="bs-btn">How Does Your Browser Compare?</a>
  </p>
  <!--
  <p>
    So far <strong>X</strong> users have run the tests <strong>X</strong> times on <strong>X</strong> unique browsers.
  </p>
  -->
</div>

<div id="bs-home-cur-ua">
  <span class="bs-cur-ua goog-inline-block"></span>
  We think you're using <strong>{{ current_ua }}</strong>. <a
    href="http://code.google.com/p/browserscope/issues/entry?template=UA%20Parsing%20Is%20Incorrect"
    target="_blank">No?</a>
</div>
{% if message %}
  <p class="d-msg">{{ message }}</p>
{% endif %}
<div id="bs-results">
  <ul id="bs-results-bycat" class="bs-compact">
    {% for app_category in app_categories %}
      {% with app_category|by_key:0 as category %}
        <li
          id="{{ category }}-results">
          <h3>{{ app_category|by_key:1 }}</h3>
          {% ifequal stats_table_category category %}
            {{ stats_table|safe }}
          {% else %}
            <a
              id="{{ category }}-results-link"
              href="/?category={{ category }}&{{ results_params }}">View the {{ app_category|by_key:1 }} Results Table</a>
          {% endifequal %}
        </li>
      {% endwith %}
    {% endfor %}
  </ul>
</div>
<script src="{{ "xhrio.js"|resource_path }}"></script>
<script>
(function(){
  var xhrLoading = {};
  var hideCategoryFamilySubmit = function(category) {
    document.getElementById('rt-' + category +
        '-v-s').style.display = 'none';
  };
  var changeCategoryClickHandler = function() {
    var isErrorClick = this.parentNode.className == 'rt-err';
    // this is some anchor with .category
    if (selectedCategoryLink == this && !isErrorClick) {
      return false; // prevent href
    }

    var oldCategory = selectedCategoryLink.category;
    categorySections[oldCategory].style.display = 'none';
    selectedCategoryLink.parentNode.className = '';

    // Reset to be the new one.
    var link = categoryTabLinks[this.category];
    selectedCategoryLink = link;
    var newCategory = selectedCategoryLink.category;
    selectedCategoryLink.parentNode.className = 'bs-sel';
    var el = categorySections[newCategory];

    // XHR if we need to.
    if ((isErrorClick || el.innerHTML == '') &&
        !xhrLoading[newCategory]) {
      xhrCategoryResults(newCategory,
          getBrowserFamilyValue(oldCategory));
    } else {
      el.style.display = '';
    }

    return false; // prevent href
  };
  var getBrowserFamilyValue = function(category) {
    var browserFamilyValue;
    var browserFamilySelect =
        document.getElementById('rt-' + category + '-v');
    if (browserFamilySelect) {
      browserFamilyValue = browserFamilySelect.options[
          browserFamilySelect.options.selectedIndex].value;
    }
    return browserFamilyValue;
  };
  var xhrCategoryResults = function(category, browserFamilyValue) {
    var el = categorySections[category];
    var categoryName = categoryNames[category];
    el.style.display = '';
    el.className = 'rt-loading';
    el.innerHTML = 'Loading the ' + categoryName + ' Results...';
    xhrLoading[category] = true;

    // results_params are their possibly recently gotten results.
    var url = '/?category=' + category +
        '&o=xhr&v=' + browserFamilyValue + '&{{ results_params }}';
    goog.net.XhrIo.send(url, function(e) {
      loadStatsTableCallback(e, category, url);
    }, 'get', null, null, 15000); // 15000 = 15 second timeout
  };
  var browserFamilyChangeHandler = function() {
    var category = selectedCategoryLink.category
    xhrCategoryResults(category, getBrowserFamilyValue(category));
  };
  var loadStatsTableCallback = function(e, category, url) {
    var xhrio = e.target;
    if (xhrio.isSuccess()) {
      categorySections[category].className = '';
      var html = xhrio.getResponseText();
      categorySections[category].innerHTML = html;
      initCategory(category);
    } else {
      categorySections[category].className = 'rt-err';
      categorySections[category].innerHTML =
          '<div>Crud. We encountered a problem on our server.</div>' +
          '<div>We are aware of the issue, and apologize.</div>';
      var link = document.createElement('a');
      link.category = category;
      link.onclick = changeCategoryClickHandler;
      link.href = url;
      link.innerHTML = 'Feel free to try again.';
      categorySections[category].appendChild(link);
      xhrLoading[category] = false;
    }
  };
  var setUpBrowserFamilyForm = function(category) {
    // hide submit
    document.getElementById('rt-' + category +
        '-v-s').style.display = 'none';
    var select = document.getElementById('rt-' + category + '-v');
    select.onchange = browserFamilyChangeHandler;
    // ensure refresh doesn't make it look wrong
    document.getElementById('rt-' + category + '-v-f').reset();
  };
  var alphaCaseInsensitiveCompare = function(a, b) {
    // turns 9/10 into 9
    if (a.match(/\//) && b.match(/\//)) {
      a = a.replace(/\/.*/, '');
      b = b.replace(/\/.*/, '');
      return goog.ui.TableSorter.numericSort(a, b);
    } else {
      a = a.toLowerCase();
      b = b.toLowerCase();
      return a > b ? 1 : a < b ? -1 : 0;
    }

  };
  var onTableSort = function(e) {
    var tableSorter = e.target;
    var yourResultsRow = document.getElementById('rt-' +
        tableSorter.category + '-ua-s-r');
    if (yourResultsRow) {
      yourResultsRow.style.display = 'none';
    }
  };
  var setUpSortableTable = function(category) {
    var table = document.getElementById('rt-' + category + '-t');
    if (!table) { return; }
    var tableSorter = new goog.ui.TableSorter();
    tableSorter.category = category;
    tableSorter.setDefaultSortFunction(alphaCaseInsensitiveCompare);
    // we know # tests should be numeric sort
    var thead = table.getElementsByTagName('thead')[0];
    var ths = thead.getElementsByTagName('th');
    var numTestsIndex = ths.length - 1;
    tableSorter.setSortFunction(numTestsIndex,
        goog.ui.TableSorter.numericSort);
    tableSorter.decorate(table);
    goog.events.listen(tableSorter,
        goog.ui.TableSorter.EventType.SORT, onTableSort, false);
  };
  var initCategory = function(category) {
    setUpBrowserFamilyForm(category);
    setUpSortableTable(category);
  };

  // hide the current form button, etc..
  initCategory('{{ stats_table_category }}');

  var categoriesList = document.createElement('ul');
  categoriesList.id = 'bs-results-cats';
  categoriesList.className = 'bs-compact';
  var categories = [];
  var categorySections = {};
  var categoryNames = {};
  var categoryTabLinks = {};
  var parent, h3;
  {% for app_category in app_categories %}
    parent = document.getElementById('{{ app_category|by_key:0 }}-results');
    categorySections['{{ app_category|by_key:0 }}'] = parent;
    categoryNames['{{ app_category|by_key:0 }}'] = '{{ app_category|by_key:1 }}'
    categories.push('{{ app_category|by_key:0 }}');
    h3 = parent.getElementsByTagName('h3')[0];
    parent.removeChild(h3);
  {% endfor %}
  var selectedCategoryLink;
  for (var i = 0, category; category = categories[i]; i++) {
    var link = document.createElement('a');
    link.href = '/?category=' + category + '&{{ results_params }}';
    var li = document.createElement('li');
    var re = new RegExp('\\?' + category + '_results=');
    li.appendChild(link);
    link.category = category;
    link.appendChild(document.createTextNode(categoryNames[category]));
    link.onclick = changeCategoryClickHandler;
    categoryTabLinks[category] = link;
    if (category == '{{ stats_table_category }}') {
      selectedCategoryLink = link;
      selectedCategoryLink.parentNode.className = 'bs-sel';
    // Otherwise initially wipe out the contents, we'll replace via xhr.
    } else {
      categorySections[category].innerHTML = '';
      categorySections[category].style.display = 'none';
    }
    categoriesList.appendChild(li);
  }
  var results = document.getElementById('bs-results');
  var resultsByCat = document.getElementById('bs-results-bycat');
  results.insertBefore(categoriesList, resultsByCat);
})();
</script>
{% endblock %}


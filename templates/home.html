{% extends "base.html" %}

{% block body %}

<div id="bs-home-intro-c" class="g-section">
  <div id="bs-home-recent-c">
    <div id="bs-home-recent">
      <h3>
        Recent tests
        {% if is_admin %}
          <a href="/clear_memcache?recent=1&continue=/" class="bs-admin">clear</a>
        {% endif %}
      </h3>
      <table id="bs-home-recent-tests" cellpadding="0" cellspacing="0">
        {% for test in recent_tests %}
          <tr>
            <td>{{ test.created|utc_to_pst|date:"P" }} PST</td>
            <td>{{ test.created|utc_to_pst|date:"N j" }}</td>
            <td>{{ test.category }}</td>
            <td>{{ test.user_agent_pretty }}</td>
          </tr>
        {% endfor %}
      </table>
    </div>
  </div>

  <p id="bs-home-intro">
    {{ app_title }} is a community-driven project for profiling web browsers.
    The goals are to foster innovation by tracking browser compatibility and performance and to be a resource for web developers.
  </p>
  <p id="bs-home-intro-sub">
    Gathering test results from users "in the wild" is the most important and useful feature of {{ app_title }} - and you can participate!
  </p>
  <p>
    <a href="/alltests" class="bs-btn">How Does Your Browser Compare? Find Out Â»</a>
  </p>
  <!--
  <p>
    So far <strong>X</strong> users have run the tests <strong>X</strong> times on <strong>X</strong> unique browsers.
  </p>
  -->
</div>

<h2 id="bs-results-title">Results</h2>
{% if message %}
  <p class="d-msg">{{ message }}</p>
{% endif %}
<div id="bs-results">
  <ul id="bs-results-bycat" class="bs-compact">
    {% for app_category in app_categories %}
      {% with app_category|by_key:0 as category %}
        <li
          id="{{ category }}-results">
          <h3>{{ app_category|by_key:1 }}</h3>
          {% ifequal stats_table_category category %}
            {{ stats_table }}
          {% else %}
            <a
              id="{{ category }}-results-link"
              href="/?category={{ category }}&{{ results_params }}">View the {{ app_category|by_key:1 }} Results Table</a>
          {% endifequal %}
        </li>
      {% endwith %}
    {% endfor %}
  </ul>
</div>
<script src="{{ "xhrio.js"|resource_path }}"></script>
<script>
(function(){
  var xhrLoading = {};
  var changeCategoryClickHandler = function() {
    var link = this;
    if (selectedCategoryLink == link) {
      return;
    }
    categorySections[selectedCategoryLink.category].style.display = 'none';
    selectedCategoryLink.parentNode.className = '';

    // Reset to be the new one.
    selectedCategoryLink = link;
    selectedCategoryLink.parentNode.className = 'bs-sel';
    var el = categorySections[selectedCategoryLink.category];
    el.style.display = '';

    // XHR if we need to.
    if (el.innerHTML == '' && !xhrLoading[selectedCategoryLink.category]) {
      el.className = 'bs-loading';
      el.innerHTML = 'Loading the ' + selectedCategoryLink.categoryName +
          ' Results...';
      xhrLoading[selectedCategoryLink.category] = true;
      var url = '/?category=' + selectedCategoryLink.category +
          '&xhr=1&{{ results_params }}';
      goog.net.XhrIo.send(url, function(e) {
        loadStatsTableCallback(e, selectedCategoryLink.category);
      }, 'get', null, null, 15000); // 15 second timeout
    }
  };
  var loadStatsTableCallback = function(e, category) {
    categorySections[category].className = '';
    var xhrio = e.target;
    if (xhrio.isSuccess()) {
      var html = xhrio.getResponseText();
      categorySections[category].innerHTML = html;
    } else {
      alert('We encountered an error. ' +
          'We are indeed aware of this issue, and apologize. ' +
          'Feel free to try refresh and try again.');
      xhrLoading[category] = false;
      categorySections[category].innerHTML = '';
    }
  };

  var categoriesList = document.createElement('ul');
  categoriesList.id = 'bs-results-cats';
  categoriesList.className = 'bs-compact';
  var categories = [];
  var categorySections = {};
  var parent, h3;
  {% for app_category in app_categories %}
    parent = document.getElementById('{{ app_category|by_key:0 }}-results');
    categorySections['{{ app_category|by_key:0 }}'] = parent;
    categories.push({
      'key': '{{ app_category|by_key:0 }}',
      'name': '{{ app_category|by_key:1 }}'
    });
    h3 = parent.getElementsByTagName('h3')[0];
    parent.removeChild(h3);
  {% endfor %}
  var selectedCategoryLink;
  for (var i = 0, category; category = categories[i]; i++) {
    var link = document.createElement('span');
    var li = document.createElement('li');
    var re = new RegExp('\\?' + category.key + '_results=');
    li.appendChild(link);
    link.category = category.key;
    link.categoryName = category.name;
    link.appendChild(document.createTextNode(category.name));
    link.onclick = changeCategoryClickHandler;
    if (category.key == '{{ stats_table_category }}') {
      selectedCategoryLink = link;
      selectedCategoryLink.parentNode.className = 'bs-sel';
    // Otherwise initially wipe out the contents, we'll replace via xhr.
    } else {
      categorySections[category.key].innerHTML = '';
      categorySections[category.key].style.display = 'none';
    }
    categoriesList.appendChild(li);
  }
  var results = document.getElementById('bs-results');
  var resultsByCat = document.getElementById('bs-results-bycat');
  results.insertBefore(categoriesList, resultsByCat);
})();
</script>
{% endblock %}


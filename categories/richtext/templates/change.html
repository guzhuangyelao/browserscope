<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Change Existing Formatting</title>
    <script src="{{ "js/range.js"|resource_path:"richtext" }}"></script>
    <script>
    
      var TESTS = {
          'backcolor' : {
            type: 'value',
            tests: [
              {html: '<FONT style="BACKGROUND-COLOR: #ffccaa">foo bar baz</FONT>', opt_arg: '#884422'},
              {html: '<span class="Apple-style-span" style="background-color: rgb(255, 0, 0);">foo bar baz</span>', opt_arg: '#0000ff'},
              {html: '<span style="background-color: #ff0000">foo bar baz</span>', opt_arg: '#0000ff'}
            ]
          },
          'fontname' : {
            type: 'value',
            tests: [
              {html: '<font face="Arial">foo bar baz</font>', opt_arg: 'Courier'},
              {html: '<span style="font-family:Arial">foo bar baz</span>', opt_arg: 'Courier'},
              {html: '<font face="Arial" style="font-family:Verdana">foo bar baz</font>', opt_arg: 'Courier'},
              {html: '<font face="Verdana"><font face="Arial">foo bar baz</font></font>', opt_arg: 'Courier'},
              {html: '<span style="font-family:Verdana"><font face="Arial">foo bar baz</font></span>', opt_arg: 'Courier'}
            ]
          },
          'fontsize' : {
            type: 'value',
            tests: [
              {html: '<font size=4>foo bar baz</font>', opt_arg: 3},
              {html: '<span class="Apple-style-span" style="font-size: large;">foo bar baz</span>', opt_arg: 3},
              {html: '<font size=1 style="font-size:x-small;">foo bar baz</font>', opt_arg: 3}
            ]
          },
          'forecolor' : {
            type: 'value',
            tests: [
              {html: '<font color="#ff0000">foo bar baz</font>', opt_arg: '#00ff00'},
              {html: '<span style="color:#ff0000">foo bar baz</span>', opt_arg: '#00ff00'},
              {html: '<font color="#0000ff" style="color:#ff0000">foo bar baz</span>', opt_arg: '#00ff00'}
            ]
          },
          'hilitecolor' : {
            type: 'value',
            tests: [
              {html: '<FONT style="BACKGROUND-COLOR: #ffccaa">foo bar baz</FONT>', opt_arg: '#884422'},
              {html: '<span class="Apple-style-span" style="background-color: rgb(255, 0, 0);">foo bar baz</span>', opt_arg: '#00ff00'},
              {html: '<span style="background-color: #ff0000">foo bar baz</span>', opt_arg: '#00ff00'}
            ]
          }
        };
      /** The document of the editable iframe */
      var editorDoc = null;
      /** Dummy text to apply and unapply formatting to */
      var TEST_CONTENT = 'foo bar baz';
      /** Constant for indicating an action is unsupported (threw exception) */
      var UNSUPPORTED = 'UNSUPPORTED';
    
      function getTestsToRun() {
        // The url param tests is a comma-separated list of the tests to run.
        // If not specified, run all tests.
        var queryString = document.location.search.replace(/^\?/, '');
        var queryParts = queryString.split('&');
        for (var i = 0; i < queryParts.length; i++) {
          var parts = queryParts[i].split('=');
          var name = parts[0].toLowerCase();
          if (name == 'tests' && parts.length > 1) {
            return parts[1].split(',');
          }
        }
        // No tests in url parameter.
        var tests = [];
        for (var key in TESTS) {
          tests.push(key);
        }
        tests.sort();
        return tests;
      }

      function findTextNode(word, node) {
        if (node.nodeType == 3) {
          // Text node, check value.
          if (node.data.indexOf(word) != -1) {
            return node;
          }
        } else if (node.nodeType == 1) {
          // Element node, check children.
          for (var i = 0; i < node.childNodes.length; i++) {
            var result = findTextNode(word, node.childNodes[i]);
            if (result) {
              return result;
            }
          }
        }
        return null;
      }

      /**
       * Selects the given word. Assumes the editor iframe contains a single text node.
       */
      function selectWord(word) {
        var textNode = findTextNode(word, editorDoc.body);
        if (!textNode) {
          return;
        }
        var start = textNode.data.indexOf(word);
        var range = createFromNodes(textNode, start, textNode, start + word.length);
        range.select();
      }
      
      function runCommand(command, index) {
        editorDoc.body.innerHTML = TESTS[command].tests[index].html;
        selectWord(TEST_CONTENT);
        try {
          editorDoc.execCommand(command, false, TESTS[command].tests[index].opt_arg);
        } catch (ex) {
          return UNSUPPORTED;
        }
      }
      
      function outputResult(command, index) {        
        // Each command is displayed as a table row with 4 columns
        var tr = document.createElement('TR');
        
        // Column 1: command name
        var td = document.createElement('TD');
        td.innerHTML = command;
        tr.appendChild(td);
        
        // Column 2: opt_arg
        td = document.createElement('TD');
        td.innerHTML = TESTS[command].tests[index].opt_arg;
        tr.appendChild(td);
        
        // Column 3: original html
        td = document.createElement('TD');
        td.innerHTML = TESTS[command].tests[index].html.replace(/\</g, '&lt;').replace(/\>/g, '&gt;');;
        tr.appendChild(td);
        
        // Column 4: resulting html
        td = document.createElement('TD');
        td.innerHTML = editorDoc.body.innerHTML.replace(/\</g, '&lt;').replace(/\>/g, '&gt;');;
        tr.appendChild(td);
        
        var table = document.getElementById('output');
        table.appendChild(tr);
      }
      
      function runTests() {
        editorDoc = document.getElementById('editor').contentWindow.document;
        // Always set styleWithCSS to false, since it's not supported by IE.
        try {
          editorDoc.execCommand('styleWithCSS', false, false);
        } catch (ex) {
          // Not supported by IE.
        }
        var commands = getTestsToRun();
        for (var i = 0; i < commands.length; i++) {
          for (var j = 0; j < TESTS[commands[i]].tests.length; j++) {
            runCommand(commands[i], j);
            outputResult(commands[i], j);
          }
        }
      }
    </script>
    <style>
      .success {
        background-color: #93c47d;
      }
      .fail {
        background-color: #ea9999;
      }
    </style>
</head>
<body onload="runTests()">
  <table><tbody id="output"><tr><th>Command</th><th>Argument</th><th>Original HTML</th><th>Resulting HTML</th></tr></tbody></table>
  <iframe name="editor" id="editor" src="editable.html"></iframe>
</body>
</html>

<!DOCTYPE html>

<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Rich Text Tests</title>
  <script src="{{ "js/range.js"|resource_path:"richtext" }}"></script>
  <script>
      /** The document of the editable iframe */
      var editorDoc = null;
      /** Dummy text to apply and unapply formatting to */
      var TEST_CONTENT = 'foo bar baz';
      /**
       * Word in dummy text that should change. Formatting is applied to a
       * single word instead of the entire text node because sometimes a 
       * style might get applied to the body node instead of wrapped around
       * the text, and that's not what's being tested.
       */
      var TEST_WORD = 'bar';
      /** Constant for indicating an action is unsupported (threw exception) */
      var UNSUPPORTED = 'UNSUPPORTED';
      var applyResult = {};
      var unapplyResult = {};
      var unapplyExtraResult = [];
 
      /** Escape HTML before displaying it */
      function htmlEscape(str) {
        return str.replace(/>/g, '&gt;').replace(/</g, '&lt;');
      }
    
      /**
       * Selects all in the editor. Used prior to execCommand. 
       */
      function selectAll() {
        var range = createFromNodes(editorDoc.body, 0, editorDoc.body, editorDoc.body.childNodes.length);
        range.select();
      }
      
      /**
       * Sets the selection to be collapsed at the start of the word,
       * or the start of the editor if no word is passed in.
       */
       function selectStart(word) {
         var textNode = findTextNode(word || '', editorDoc.body);
         var startOffset = 0;
         if (word) {
           startOffset = textNode.data.indexOf(word);
         }
         var range = createCaret(textNode, startOffset);
         range.select();
       }

      /**
       * Selects the given word. Assumes the editor iframe contains a single text node.
       */
      function selectWord(word) {
        var textNode = findTextNode(word, editorDoc.body);
        if (!textNode) {
          return;
        }
        var start = textNode.data.indexOf(word);
        var range = createFromNodes(textNode, start, textNode, start + word.length);
        range.select();
      }

      function findTextNode(word, node) {
        if (node.nodeType == 3) {
          // Text node, check value.
          if (node.data.indexOf(word) != -1) {
            return node;
          }
        } else if (node.nodeType == 1) {
          // Element node, check children.
          for (var i = 0; i < node.childNodes.length; i++) {
            var result = findTextNode(word, node.childNodes[i]);
            if (result) {
              return result;
            }
          }
        }
        return null;
      }
 
      /** 
       * Gets the HTML before the text, so that we know how the browser
       * applied a style
       */
      function getSurroundingTags(text) {
        var html = editorDoc.body.innerHTML;
        var tagStart = html.indexOf('<');
        var index = editorDoc.body.innerHTML.indexOf(text);
        if (tagStart == -1 || index == -1) {
          return '';
        }
        return editorDoc.body.innerHTML.substring(tagStart, index);
      }

      /**
       * Sets the HTML of the document, and runs the given execCommand.
       * @param html The HTML to initialize the editor to
       * @param command The command to pass to execCommand
       * @param opt_arg Argument to pass onto the third execCommand param.
       * @param collapse If true, this execCommand should be applied to a
       * collapsed selection.
       * @return The HTML before TEST_CONTENT after the execCommand is run.
       * This shows whether the expected formatting was applied.
       */
      function runCommand(html, command, opt_arg, collapse) {
        editorDoc.body.innerHTML = html;
        if (collapse) {
          selectStart(TEST_WORD);
        }  else {
          selectWord(TEST_WORD);
        }
        try {
          editorDoc.execCommand(command, false, opt_arg);
        } catch (ex) {
          return UNSUPPORTED;
        }
        return getSurroundingTags(TEST_WORD);
      }
      
      function statusHeader(command) {
        var h = document.createElement('h2');
        h.innerHTML = 'Testing ' + command + '...';
        document.getElementById('output').appendChild(h);
      }
      
      function statusSuccess(p, command, test, reason) {
        p.innerHTML = p.innerHTML + test + ' SUCCESS';
        if (reason) {
          p.innerHTML = p.innerHTML + ': ' + reason;
        }
        p.innerHTML = p.innerHTML + '<br>';
      }
      
      function statusFail(p, command, test, reason) {
        p.innerHTML = p.innerHTML + test + ' FAIL';
        if (reason) {
          p.innerHTML = p.innerHTML + ': ' + reason;
        }
        p.innerHTML = p.innerHTML + '<br>';
      }
      
      function runCommandTest(content, command, shouldApply, opt_arg, collapse, outputElement, testName, dict) {
        result = runCommand(content, command, opt_arg, collapse);
        if (result == UNSUPPORTED) {
          statusFail(outputElement, command, testName, 'Error executing command');
          dict[command] = false;
        } else if (shouldApply && !result) {
          statusFail(outputElement, command, testName, 'No style applied');
          dict[command] = false;
        } else if (!shouldApply && result) {
          statusFail(outputElement, command, testName, '"' + htmlEscape(result) + '" not removed.');
        } else {
          statusSuccess(outputElement, command, testName, shouldApply ? ('Applied "' + htmlEscape(result) +'"') : '');
          dict[command] = true;
        }
      }
      
      function score(command) {
        var sum = 0;
        if (applyResult[command]) {
         sum++;
        }
        if (unapplyResult[command]) {
         sum++;
        }
        for (var i = 0; i < unapplyExtraResult.length; i++) {
          if (unapplyExtraResult[i][command]) {
            sum++;
          }
        }
        return sum;
      }
      
      function testCommand(command, testUnapply, opt_arg, collapse, extraFormats) {
        statusHeader(command);
        p = document.createElement('p');
        document.getElementById('output').appendChild(p);
        runCommandTest(TEST_CONTENT, command, true, opt_arg, collapse, p, 'Apply Style: ', applyResult);
        if (testUnapply && applyResult[command]) {
          runCommandTest(editorDoc.body.innerHTML, command, false, opt_arg, collapse, p, 'Unapply browser-applied Style: ', unapplyResult);
        }
        for (var i = 0; i < extraFormats.length; i++) {
          unapplyExtraResult[i] = unapplyExtraResult[i] || {};
          var wordStart = TEST_CONTENT.indexOf(TEST_WORD);
          var wordEnd = wordStart + TEST_WORD.length;
          runCommandTest(TEST_CONTENT.substring(0, wordStart) + extraFormats[i][0] + TEST_WORD + extraFormats[i][1] + TEST_CONTENT.substring(wordEnd),
              command, false, opt_arg, collapse, p,
              'Unapply common browser style "' + htmlEscape(extraFormats[i][0]) + ' ', 
              unapplyExtraResult[i]);
        }
        return score(command);
      }
      
      /**
       * When the onload event fires, editing iframe is fully loaded and
       * tests can run.
       */
      function runTests() {
        editorDoc = document.getElementById('editor').contentWindow.document;
        // Always set styleWithCSS to false, since it's not supported by IE.
        try {
          editorDoc.execCommand('styleWithCSS', false, false);
        } catch (ex) {
          // Not supported by IE.
        }
        editorDoc.body.innerHTML = TEST_CONTENT;
        {% autoescape off %}
        var results = [];
{{ code }}
        var token = '{{ csrf_token }}';
        var url = '/beacon?category=richtext&csrf_token=' + token + '&results=' + results.join(',');
        new Image().src = url;
        {% endautoescape %}
      }
 
  </script>
</head>
<body onload="runTests();">

  <div id="output"></div> 
  <iframe name="editor" id="editor" src="editable.html"></iframe>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Unapply Formatting Tests</title>
    <script src="{{ "js/range.js"|resource_path:"richtext" }}"></script>
    <script>
      var TESTS = {
          'bold' : {
            'tags': [
              ['<b>', '</b>'],
              ['<STRONG>', '</STRONG>'],
              ['<span style="font-weight: bold;">', '</span>']]},
//          'formatblock' : {
//            'opt_arg': 'h1',
//            'tags': [
//              ['<h1>', '</h1>']]},
          'italic' : {
            'tags': [
              ['<i>', '</i>'],
              ['<EM>', '</EM>'],
              ['<span style="font-style: italic;">', '</span>']]},
          'outdent' : {
            'unapply': 'indent',
            'block': true,
            'tags': [
              ['<blockquote>', '</blockquote>'],
              ['<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">', '</BLOCKQUOTE>'],
              ['<blockquote class="webkit-indent-blockquote" style="margin: 0 0 0 40px; border: none; padding: 0px;">', '</blockquote>'],
              ['<ul><li>', '</li></ul>'],
              ['<ol><li>', '</li></ol>'],
              ['<div style="margin-left: 40px;">', '</div>']]},
          'removeformat' : {
            'unapply': '*',
            'block': true,
            'tags': [
              ['<b>', '</b>'],
              ['<a href="http://www.foo.com">', '</a>'],
              ['<table><tr><td>', '</td></tr></table>']]},
          'strikethrough' : {
            'tags': [
              ['<strike>', '</strike>'],
              ['<s>', '</s>'],
              ['<del>', '</del>'],
              ['<span style="text-decoration: line-through;">', '</span>']]},
          'subscript' : {
            'tags': [
              ['<sub>', '</sub>'],
              ['<span style="vertical-align: sub;">', '</span>']]},
          'superscript' : {
            'tags': [
              ['<sup>', '</sup>'],
              ['<span style="vertical-align: sup;">', '</span>']]},
          'unbookmark' : {
            'unapply': 'createbookmark',
            'tags': [
              ['<a name="bookmark">', '</a>']]},
          'underline' : {
            'tags': [
              ['<u>', '</u>'],
              ['<span style="text-decoration: underline;">', '</span>']]},
          'unlink' : {
            'unapply': 'createbookmark',
            'tags': [
              ['<a href="http://www.foo.com">', '</a>']]}};
            
      /** The document of the editable iframe */
      var editorDoc = null;
      /** Dummy text to apply and unapply formatting to */
      var TEST_CONTENT = 'foo bar baz';
      /**
       * Word in dummy text that should change. Formatting is applied to a
       * single word instead of the entire text node because sometimes a 
       * style might get applied to the body node instead of wrapped around
       * the text, and that's not what's being tested.
       */
      var TEST_WORD = 'bar';
      /** Constant for indicating an action is unsupported (threw exception) */
      var UNSUPPORTED = 'UNSUPPORTED';
      /** <br> and <p> are acceptable HTML to be left over from block elements */
      var BLOCK_REMOVE_TAGS = [/\s*<br>\s*/i, /\s*<p>\s*/i];
    
      function getTestsToRun() {
        // The url param tests is a comma-separated list of the tests to run.
        // If not specified, run all tests.
        var queryString = document.location.search.replace(/^\?/, '');
        var queryParts = queryString.split('&');
        for (var i = 0; i < queryParts.length; i++) {
          var parts = queryParts[i].split('=');
          var name = parts[0].toLowerCase();
          if (name == 'tests' && parts.length > 1) {
            return parts[1].split(',');
          }
        }
        // No tests in url parameter.
        var tests = [];
        for (var key in TESTS) {
          tests.push(key);
        }
        tests.sort();
        return tests;
      }

      function findTextNode(word, node) {
        if (node.nodeType == 3) {
          // Text node, check value.
          if (node.data.indexOf(word) != -1) {
            return node;
          }
        } else if (node.nodeType == 1) {
          // Element node, check children.
          for (var i = 0; i < node.childNodes.length; i++) {
            var result = findTextNode(word, node.childNodes[i]);
            if (result) {
              return result;
            }
          }
        }
        return null;
      }

      /**
       * Selects the given word. Assumes the editor iframe contains a single text node.
       */
      function selectWord(word) {
        var textNode = findTextNode(word, editorDoc.body);
        if (!textNode) {
          return;
        }
        var start = textNode.data.indexOf(word);
        var range = createFromNodes(textNode, start, textNode, start + word.length);
        range.select();
      }
 
      /** 
       * Gets the HTML before the text, so that we know how the browser
       * applied a style
       */
      function getSurroundingTags(text) {
        var html = editorDoc.body.innerHTML;
        var tagStart = html.indexOf('<');
        var index = editorDoc.body.innerHTML.indexOf(text);
        if (tagStart == -1 || index == -1) {
          return '';
        }
        return editorDoc.body.innerHTML.substring(tagStart, index);
      }

      function runCommand(command, index) {
        var wordStart = TEST_CONTENT.indexOf(TEST_WORD);
        editorDoc.body.innerHTML =
          TEST_CONTENT.substring(0, wordStart) +
          TESTS[command].tags[index][0] +
          TEST_WORD +
          TESTS[command].tags[index][1] +
          TEST_CONTENT.substring(wordStart + TEST_WORD.length);
        selectWord(TEST_WORD);
        try {
          editorDoc.execCommand(command, false, TESTS[command].opt_arg || null);
        } catch (ex) {
          return UNSUPPORTED;
        }
        return getSurroundingTags(TEST_WORD);
      }
      
      /**
       * Check if the given command succeeded. It succeeded if the following
       * conditions are true:
       *   - The execCommand did not throw an exception
       *   - One of the following:
       *     - The html was removed after the execCommand
       *     - The html was block and the html was replaced with <p> or <br>
       */
      function commandSucceeded(command, result) {
        if (result != UNSUPPORTED) {
          if (!result) {
            return true;
          } else if (TESTS[command].block) {
            for (var i = 0; i < BLOCK_REMOVE_TAGS.length; i++) {
              if (result.match(BLOCK_REMOVE_TAGS[i])) {
                return true;
              }
            }
          }
        }
        return false;
      }
      
      function outputResult(command, result, index) {
        // The apply command "succeeded" if HTML was removed.
        var success = commandSucceeded(command, result);
        
        // Each command is displayed as a table row with 5 columns
        var tr = document.createElement('TR');
        tr.className = success ? 'success' : 'fail';
        
        // Column 1: command name
        var td = document.createElement('TD');
        td.innerHTML = command;
        tr.appendChild(td);
        
        // Column 2: command name being unapplied
        var td = document.createElement('TD');
        td.innerHTML = TESTS[command].unapply || command;
        tr.appendChild(td);
        
        // Column 3: pass/fail
        td = document.createElement('TD');
        td.innerHTML = success ? 'PASS' : 'FAIL';
        tr.appendChild(td);
        
        // Column 4: html being removed
        td = document.createElement('TD');
        // Escape the html for printing.
        var htmlToRemove = TESTS[command].tags[index][0].replace(/\</g, '&lt;').replace(/\>/g, '&gt;');
        td.innerHTML = htmlToRemove;
        tr.appendChild(td);
        
        // Column 5: resulting html
        td = document.createElement('TD');
        // Escape the HTML in the result for printing.
        result = result.replace(/\</g, '&lt;').replace(/\>/g, '&gt;');
        td.innerHTML = success ? '&nbsp;' : result;
        tr.appendChild(td);
        var table = document.getElementById('output');
        table.appendChild(tr);
      }
      
      function runTests() {
        editorDoc = document.getElementById('editor').contentWindow.document;
        // Always set styleWithCSS to false, since it's not supported by IE.
        try {
          editorDoc.execCommand('styleWithCSS', false, false);
        } catch (ex) {
          // Not supported by IE.
        }
        var commands = getTestsToRun();
        for (var i = 0; i < commands.length; i++) {
          for (var j = 0; j < TESTS[commands[i]].tags.length; j++) {
            var result = runCommand(commands[i], j);
            outputResult(commands[i], result, j);
          }
        }
      }
    </script>
    <style>
      .success {
        background-color: #93c47d;
      }
      .fail {
        background-color: #ea9999;
      }
    </style>
</head>
<body onload="runTests()">
  <table><tbody id="output"><tr><th>Command</th><th>Command unapplied</th><th>Status</th><th>HTML Attempted to Unapply</th><th>Resulting HTML</th></tr></tbody></table>
  <iframe name="editor" id="editor" src="editable.html"></iframe>
</body>
</html>
